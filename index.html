<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WePlay Simulator v2</title>
<style>
body{
    font-family:Arial;
    background:#f4f6fb;
    padding:20px;
}

h1{margin-top:0}

.card{
    background:white;
    padding:15px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    margin-bottom:15px;
}

.simGrid{
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:25px;
    align-items:start;
}

.leftPanel{
    display:flex;
    flex-direction:column;
    gap:15px;
}

.rightPanel{
    height:75vh;
}


button{
    border:none;
    padding:8px 12px;
    border-radius:6px;
    cursor:pointer;
    font-weight:bold;
}

.btnTime{background:#4CAF50;color:white}
.btnUndo{background:#f44336;color:white}

.actionGrid{
    display:grid;
    grid-template-columns: repeat(4,1fr);
    gap:10px;
}

.actionBtn{
    background:#eef2ff;
    font-size:22px;
    padding:15px;
}

table{
    width:100%;
    border-collapse:collapse;
}


td,th{
    border-bottom:1px solid #ddd;
    padding:6px;
    text-align:center;
}

.timeline{
    max-height:75vh;
    overflow-y:auto;
    width:100%;
}

td:nth-child(4),
td:nth-child(5){
    text-align:left;
    word-break:break-word;
    white-space:normal;
}

/* ================= MOBILE VERSION ================= */
@media (max-width: 900px){
    
    /* ƒë·ªïi th·ª© t·ª±: control tr√™n - timeline d∆∞·ªõi */
.leftPanel{
    order:1;
}

.rightPanel{
    order:2;
}

    body{
        padding:12px;
        font-size:16px;
    }

    h1{font-size:22px}

    /* chuy·ªÉn grid 2 c·ªôt ‚Üí 1 c·ªôt */
    .simGrid{
    display:flex;
    flex-direction:column;
}


    /* timeline xu·ªëng d∆∞·ªõi */
    .rightPanel{
        height:auto;
    }

    /* n√∫t to h∆°n cho ng√≥n tay */
    button{
        padding:12px;
        font-size:16px;
    }

    /* icon action to */
    .actionBtn{
        font-size:28px;
        padding:18px;
    }

    /* grid action 4 n√∫t ‚Üí 2 n√∫t m·ªói h√†ng */
    .actionGrid{
        grid-template-columns: repeat(2,1fr);
    }

    /* input to h∆°n */
    input, select{
        width:100%;
        padding:8px;
        font-size:16px;
        margin-top:4px;
    }

    /* b·∫£ng timeline cu·ªôn ngang n·∫øu d√†i */
    .timeline{
        overflow-x:auto;
    }

    table{
        min-width:650px;
    }
}

.timelineWindow{
    position:fixed;
    right:20px;
    bottom:20px;
    width:220px;
    background:white;
    border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,0.25);
    z-index:999;
}

.timelineHeader{
    background:#4CAF50;
    color:white;
    padding:8px;
    border-radius:12px 12px 0 0;
    cursor:move;
    font-weight:bold;
}

</style>
</head>
<body>

<h1>STEP 1 ‚Äî GAME CONFIG</h1>

<h3>Nh·∫≠p s·ªë level mu·ªën d√πng</h3>
Tree levels <input id="treeLvCount" value="5">
Pump levels <input id="pumpLvCount" value="5">
House levels <input id="houseLvCount" value="5">
Door levels <input id="doorLvCount" value="5">
Gun levels <input id="gunLvCount" value="5">


<button onclick="generateTables()">T·∫°o b·∫£ng nh·∫≠p li·ªáu</button>
<button onclick="saveConfig()">üíæ L∆∞u config</button>
<button onclick="loadConfig()">üìÇ T·∫£i config</button>
<button onclick="exportConfig()">‚¨á Export file</button>
<input type="file" id="importFile" onchange="importConfig(event)">

<div id="tables"></div>

<button onclick="startSim()">üöÄ B·∫ÆT ƒê·∫¶U GI·∫¢ L·∫¨P</button>

<hr>
<div id="simulator" class="hidden">

<h1>STEP 2 ‚Äî SIMULATOR</h1>

<div class="simGrid">

<div class="leftPanel">

<div class="card">
<h3>Actions</h3>
<div class="card">
<h3>üî´ Trang b·ªã s√∫ng</h3>

<select id="gunBuySelect"></select>
<button onclick="buyGun()">Mua s√∫ng</button>

<br><br>

<select id="gunUpgradeSelect"></select>
<button onclick="upgradeGun()">N√¢ng c·∫•p s√∫ng</button>

<p id="gunStatus">Ch∆∞a c√≥ s√∫ng</p>
</div>

<div class="actionGrid">

<button class="actionBtn" onclick="buyTree()">üå≥</button>
<button class="actionBtn" onclick="buyPump()">üíß</button>

<select id="treeUpgradeSelect"></select>
<button class="actionBtn" onclick="upgradeTree()">üå≤‚¨Ü</button>

<select id="pumpUpgradeSelect"></select>
<button class="actionBtn" onclick="upgradePump()">üí¶‚¨Ü</button>

<button class="actionBtn" onclick="upgradeHouse()">üè†‚¨Ü</button>
<button class="actionBtn" onclick="upgradeDoor()">üö™‚¨Ü</button>

</div>


</div>



</div>
<div class="card timeline rightPanel">
<table id="timeline">
<tr>
<th>Time</th>
<th>Gold</th>
<th>Water</th>
<th>Trees</th>
<th>Pumps</th>
<th>House</th>
<th>Door</th>
</tr>
</table>
</div>
</div>

<script>

let CONFIG = {};
let history=[];
let state;

// ===== INPUT TABLE FUNCTIONS (b·ªã thi·∫øu) =====
function makeLevelTable(name,count){
    let html=`<h3>${name}</h3>
    <table>
    <tr>
        <th>Lv</th>
        <th>Gold cost</th>
        <th>Water cost</th>
        <th>Production/s</th>
        <th>Req Door Lv</th>
    </tr>`;

    for(let i=1;i<=count;i++){
        html+=`<tr>
        <td>${i}</td>
        <td><input id="${name}_gold_${i}" value="0"></td>
        <td><input id="${name}_water_${i}" value="0"></td>
        <td><input id="${name}_prod_${i}" value="0"></td>
        <td><input id="${name}_doorReq_${i}" value="1"></td>
        </tr>`;
    }

    html+="</table>";
    return html;
}

function generateTables(){
    tables.innerHTML =
        makeLevelTable("tree",+treeLvCount.value)+
        makeLevelTable("pump",+pumpLvCount.value)+
        makeLevelTable("house",+houseLvCount.value)+
        makeLevelTable("door",+doorLvCount.value)+
        makeLevelTable("gun",+gunLvCount.value);
}



function readTable(name,count){
    let arr=[];
    for(let i=1;i<=count;i++){
        arr.push({
    gold:+document.getElementById(`${name}_gold_${i}`).value,
    water:+document.getElementById(`${name}_water_${i}`).value,
    prod:+document.getElementById(`${name}_prod_${i}`).value,
    doorReq:+document.getElementById(`${name}_doorReq_${i}`).value
});
    }
    return arr;
}

function saveConfig(){
    let configData = {
    treeLvCount: +treeLvCount.value,
    pumpLvCount: +pumpLvCount.value,
    houseLvCount: +houseLvCount.value,
    doorLvCount: +doorLvCount.value,
    gunLvCount: +gunLvCount.value,
    tables: {}
};

    function readTableValues(name,count){
        let arr=[];
        for(let i=1;i<=count;i++){
            arr.push({
                gold: document.getElementById(`${name}_gold_${i}`).value,
                water: document.getElementById(`${name}_water_${i}`).value,
                prod: document.getElementById(`${name}_prod_${i}`).value,
                doorReq: document.getElementById(`${name}_doorReq_${i}`).value
            });
        }
        return arr;
    }

    configData.tables.tree  = readTableValues("tree",  configData.treeLvCount);
    configData.tables.pump  = readTableValues("pump",  configData.pumpLvCount);
    configData.tables.house = readTableValues("house", configData.houseLvCount);
    configData.tables.door  = readTableValues("door",  configData.doorLvCount);
    configData.tables.gun = readTableValues("gun", configData.gunLvCount);


    localStorage.setItem("weplayConfig", JSON.stringify(configData));
    alert("ƒê√£ l∆∞u config!");
}


function loadConfig(){
    let data = localStorage.getItem("weplayConfig");
    if(!data){
        alert("Ch∆∞a c√≥ config ƒë∆∞·ª£c l∆∞u!");
        return;
    }

    data = JSON.parse(data);

    treeLvCount.value  = data.treeLvCount;
    pumpLvCount.value  = data.pumpLvCount;
    houseLvCount.value = data.houseLvCount;
    doorLvCount.value  = data.doorLvCount;
    gunLvCount.value   = data.gunLvCount;

    

    // t·∫°o l·∫°i b·∫£ng
    generateTables();

    function fillTable(name,arr){
        arr.forEach((row,i)=>{
            let idx=i+1;
            document.getElementById(`${name}_gold_${idx}`).value    = row.gold;
            document.getElementById(`${name}_water_${idx}`).value   = row.water;
            document.getElementById(`${name}_prod_${idx}`).value    = row.prod;
            document.getElementById(`${name}_doorReq_${idx}`).value = row.doorReq;
        });
    }

    fillTable("tree",  data.tables.tree);
    fillTable("pump",  data.tables.pump);
    fillTable("house", data.tables.house);
    fillTable("door",  data.tables.door);
    fillTable("gun",  data.tables.gun);


    alert("ƒê√£ t·∫£i config!");
}

function exportConfig(){
    let data = localStorage.getItem("weplayConfig");
    if(!data){
        alert("Ch∆∞a c√≥ config ƒë·ªÉ export");
        return;
    }

    let blob = new Blob([data], {type:"application/json"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "weplay-config.json";
    a.click();
}

function importConfig(event){
    let file = event.target.files[0];
    if(!file) return;

    let reader = new FileReader();
    reader.onload = function(e){
        localStorage.setItem("weplayConfig", e.target.result);
        alert("Import xong! B·∫•m t·∫£i config.");
    }
    reader.readAsText(file);
}


// ===== FORMAT TIME =====
function formatTime(sec){
    let m=Math.floor(sec/60).toString().padStart(2,"0");
    let s=(sec%60).toString().padStart(2,"0");
    return `${m}:${s}`;
}

function startSim(){
    CONFIG.tree  = readTable("tree",+treeLvCount.value);
	CONFIG.pump  = readTable("pump",+pumpLvCount.value);
	CONFIG.house = readTable("house",+houseLvCount.value);
	CONFIG.door  = readTable("door",+doorLvCount.value);
	CONFIG.gun = readTable("gun",+gunLvCount.value);


    state={
    time:8,
    gold:0,
    water:0,
    houseLv:1,
    doorLv:1,
    trees:[],
    pumps:[],
    guns:[]
};


    history=[JSON.parse(JSON.stringify(state))];

    simulator.classList.remove("hidden");

    populateUpgradeSelectors();   // ‚≠ê ƒë·∫∑t ·ªü ƒë√¢y m·ªõi ƒë√∫ng
    render();
}

// ===== PRODUCTION =====
function produceResources(){
    let goldGain=0;
    let waterGain=0;

    // m·ªói c√¢y t·∫°o v√†ng theo level ri√™ng
    state.trees.forEach(lv=>{
        goldGain += CONFIG.tree[lv-1].prod;
    });

    // nh√† t·∫°o v√†ng
    goldGain += CONFIG.house[state.houseLv-1].prod;

    // m·ªói pump t·∫°o n∆∞·ªõc theo level ri√™ng
    state.pumps.forEach(lv=>{
        waterGain += CONFIG.pump[lv-1].prod;
    });

    state.gold += goldGain;
    state.water += waterGain;
}

// ===== TIME CONTROL =====
function nextSecond(){
    produceResources();
    state.time++;
    history.push(JSON.parse(JSON.stringify(state)));
    render();
}

function prevSecond(){
    if(history.length<=1) return;
    history.pop();
    state=JSON.parse(JSON.stringify(history[history.length-1]));
    timeline.deleteRow(-1);
}

// ===== ACTIONS =====
function buyTree(){
    let cfg = CONFIG.tree[0]; // mua c√¢y lv1
    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold -= cfg.gold;
        state.water -= cfg.water;
        state.trees.push(1); // th√™m 1 c√¢y lv1
        renderInstant();
    }
}


function buyPump(){
    let cfg = CONFIG.pump[0];
    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold -= cfg.gold;
        state.water -= cfg.water;
        state.pumps.push(1);
        renderInstant();
    }
}


function upgradeHouse(){
    let lvl=state.houseLv;
    if(lvl>=CONFIG.house.length) return;
    let cfg=CONFIG.house[lvl];

    if(state.doorLv < cfg.doorReq) return;

    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold-=cfg.gold;
        state.water-=cfg.water;
        state.houseLv++;
        renderInstant();
    }
}


function upgradeDoor(){
    let lvl=state.doorLv;
    if(lvl>=CONFIG.door.length) return;
    let cfg=CONFIG.door[lvl];
    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold-=cfg.gold;
        state.water-=cfg.water;
        state.doorLv++;
        renderInstant();
    }
}

function upgradeTree(){
    let targetLv = +document.getElementById("treeUpgradeSelect").value;

    // t√¨m c√¢y c√≥ level ƒë√≥
    let index = state.trees.findIndex(lv => lv === targetLv);

    if(index === -1){
        alert("Kh√¥ng c√≥ c√¢y level n√†y!");
        return;
    }

    if(targetLv >= CONFIG.tree.length) return;

    let cfg = CONFIG.tree[targetLv];

    if(state.doorLv < cfg.doorReq){
        alert("C·∫ßn Door Lv " + cfg.doorReq);
        return;
    }

    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold -= cfg.gold;
        state.water -= cfg.water;
        state.trees[index]++;
        renderInstant();
    }
}


function upgradePump(){
    let targetLv = +document.getElementById("pumpUpgradeSelect").value;

    let index = state.pumps.findIndex(lv => lv === targetLv);

    if(index === -1){
        alert("Kh√¥ng c√≥ pump level n√†y!");
        return;
    }

    if(targetLv >= CONFIG.pump.length) return;

    let cfg = CONFIG.pump[targetLv];

    if(state.doorLv < cfg.doorReq){
        alert("C·∫ßn Door Lv " + cfg.doorReq);
        return;
    }

    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold -= cfg.gold;
        state.water -= cfg.water;
        state.pumps[index]++;
        renderInstant();
    }
}

function populateUpgradeSelectors(){
    let treeSel = document.getElementById("treeUpgradeSelect");
    let pumpSel = document.getElementById("pumpUpgradeSelect");

    treeSel.innerHTML="";
    pumpSel.innerHTML="";

    for(let i=1;i<=CONFIG.tree.length;i++){
        treeSel.innerHTML += `<option value="${i}">Tree Lv ${i}</option>`;
    }

    for(let i=1;i<=CONFIG.pump.length;i++){
        pumpSel.innerHTML += `<option value="${i}">Pump Lv ${i}</option>`;
    }

    // ===== TH√äM ƒêO·∫†N N√ÄY NGAY TR∆Ø·ªöC D·∫§U } =====
    let buySel=document.getElementById("gunBuySelect");
    let upSel=document.getElementById("gunUpgradeSelect");

    buySel.innerHTML="";
    upSel.innerHTML="";

    for(let i=1;i<=CONFIG.gun.length;i++){
        buySel.innerHTML += `<option value="${i}">Gun Lv ${i}</option>`;
        upSel.innerHTML += `<option value="${i}">Gun Lv ${i}</option>`;
    }
}

// ===== RENDER =====
function renderInstant(){
    // n·∫øu ch∆∞a c√≥ d√≤ng timeline th√¨ t·∫°o d√≤ng ƒë·∫ßu
    if(timeline.rows.length === 1){
        render();
        return;
    }

    // update d√≤ng cu·ªëi thay v√¨ x√≥a
    let lastRow = timeline.rows[timeline.rows.length-1];

    // ===== ƒê·∫æM L·∫†I TREE/PUMP/GUN =====
    let treeCountByLevel = new Array(CONFIG.tree.length).fill(0);
    state.trees.forEach(lv => treeCountByLevel[lv-1]++);
    let treeText = treeCountByLevel.map((c,i)=>`L${i+1}:${c}`).join(" | ");

    let pumpCountByLevel = new Array(CONFIG.pump.length).fill(0);
    state.pumps.forEach(lv => pumpCountByLevel[lv-1]++);
    let pumpText = pumpCountByLevel.map((c,i)=>`L${i+1}:${c}`).join(" | ");

    let gunCountByLevel = new Array(CONFIG.gun.length).fill(0);
    state.guns.forEach(lv => gunCountByLevel[lv-1]++);
    document.getElementById("gunStatus").innerText =
        gunCountByLevel.map((c,i)=>`L${i+1}:${c}`).join(" | ");

    lastRow.innerHTML = `
    <td>${formatTime(state.time)}</td>
    <td>${state.gold.toFixed(1)}</td>
    <td>${state.water.toFixed(1)}</td>
    <td>${treeText}</td>
    <td>${pumpText}</td>
    <td>${state.houseLv}</td>
    <td>${state.doorLv}</td>`;
}

function buyGun(){
    let lv = +document.getElementById("gunBuySelect").value;
    let cfg = CONFIG.gun[lv-1];

    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold -= cfg.gold;
        state.water -= cfg.water;
        state.guns.push(lv);
        renderInstant();
    }
}

function upgradeGun(){
    let lv = +document.getElementById("gunUpgradeSelect").value;
    let index = state.guns.findIndex(g => g === lv);

    if(index === -1){
        alert("Kh√¥ng c√≥ s√∫ng level n√†y!");
        return;
    }

    if(lv >= CONFIG.gun.length) return;

    let cfg = CONFIG.gun[lv];

    if(state.gold>=cfg.gold && state.water>=cfg.water){
        state.gold -= cfg.gold;
        state.water -= cfg.water;
        state.guns[index]++;
        renderInstant();
    }
}

function render(){
    let r = timeline.insertRow(-1);

    // ===== ƒê·∫æM S·ªê C√ÇY THEO LEVEL =====
    let treeCountByLevel = new Array(CONFIG.tree.length).fill(0);
    state.trees.forEach(lv => treeCountByLevel[lv-1]++);

    let pumpCountByLevel = new Array(CONFIG.pump.length).fill(0);
    state.pumps.forEach(lv => pumpCountByLevel[lv-1]++);

    // convert th√†nh text
    let treeText = treeCountByLevel
        .map((count,i)=>`L${i+1}:${count}`)
        .join(" | ");

    let pumpText = pumpCountByLevel
        .map((count,i)=>`L${i+1}:${count}`)
        .join(" | ");

	let gunCountByLevel = new Array(CONFIG.gun.length).fill(0);
state.guns.forEach(lv => gunCountByLevel[lv-1]++);

document.getElementById("gunStatus").innerText =
    gunCountByLevel.map((c,i)=>`L${i+1}:${c}`).join(" | ");

    r.innerHTML = `
    <td>${formatTime(state.time)}</td>
    <td>${state.gold.toFixed(1)}</td>
    <td>${state.water.toFixed(1)}</td>
    <td>${treeText}</td>
    <td>${pumpText}</td>
    <td>${state.houseLv}</td>
    <td>${state.doorLv}</td>`;
}

// DRAG TIME WINDOW (fix load DOM)
window.addEventListener("load", ()=>{

    let win = document.getElementById("timeWindow");
    let header = win.querySelector(".timelineHeader");

    let offsetX=0, offsetY=0, isDown=false;

    header.onmousedown = e=>{
        isDown=true;
        offsetX=e.clientX-win.offsetLeft;
        offsetY=e.clientY-win.offsetTop;
    }

    document.onmouseup = ()=> isDown=false;

    document.onmousemove = e=>{
        if(!isDown) return;
        win.style.left=(e.clientX-offsetX)+"px";
        win.style.top=(e.clientY-offsetY)+"px";
        win.style.right="auto";
        win.style.bottom="auto";
    }

});

</script>
<div class="timelineWindow" id="timeWindow">
    <div class="timelineHeader">‚è± Time Control</div>
    <div style="padding:10px">
        <button class="btnTime" onclick="nextSecond()">+1 Second</button>
        <button class="btnUndo" onclick="prevSecond()">Undo</button>
    </div>
</div>
